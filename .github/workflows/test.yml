name: Codex Hello World Tests

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  codex-hello:
    runs-on: ubuntu-latest

    env:
      PYTHON_VERSION: "3.13"
      CODEX_CLI_MODEL: "gpt-4.1-mini"
      CODEX_CLI_MODEL_FALLBACKS: "gpt-4o-mini gpt-4o-mini-2024-08-06 gpt-4.1 gpt-4o-mini-2024-05-13"

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Ensure Codex secrets available
        id: ensure_codex_secrets
        env:
          CODEX_AUTH: ${{ secrets.CODEX_AUTH }}
          CODEX_AUTH_PAT: ${{ secrets.CODEX_AUTH_PAT }}
        run: |
          if [ -n "${CODEX_AUTH}" ] && [ -n "${CODEX_AUTH_PAT}" ]; then
            echo "available=true" >> "${GITHUB_OUTPUT}"
            exit 0
          fi
          echo "available=false" >> "${GITHUB_OUTPUT}"
          echo "::notice::Codex secrets missing; skipping tests."

      - name: Prepare Codex authentication
        if: ${{ steps.ensure_codex_secrets.outputs.available == 'true' }}
        env:
          CODEX_AUTH: ${{ secrets.CODEX_AUTH }}
          RUNNER_TEMP: ${{ runner.temp }}
        run: |
          set -euo pipefail
          auth_path="$HOME/.codex/auth.json"
          mkdir -p "$(dirname "$auth_path")"
          printf '%s' "$CODEX_AUTH" > "$auth_path"
          chmod 600 "$auth_path"
          echo "Wrote Codex auth to $auth_path"

      - name: Install Node and Codex CLI
        if: ${{ steps.ensure_codex_secrets.outputs.available == 'true' }}
        run: |
          npm install -g @openai/codex@latest

      - name: Simple hello world
        if: ${{ steps.ensure_codex_secrets.outputs.available == 'true' }}
        run: |
          codex --version
          codex exec --skip-git-repo-check --full-auto "say hello"

      - name: Structured hello world
        if: ${{ steps.ensure_codex_secrets.outputs.available == 'true' }}
        run: |
          set -uo pipefail
          : "${CODEX_CLI_MODEL_FALLBACKS:=}"
          echo "=== Structured output ==="
          cat <<'JSON' > schema.json
          {
            "type": "object",
            "properties": {
              "message": { "type": "string" }
            },
            "required": ["message"],
            "additionalProperties": false
          }
          JSON
          success=0
          mkdir -p codex_artifacts
          codex exec \
              --output-schema schema.json \
              -o "${output_path}" \
              "Output a JSON object with key 'message' set to 'hello world'."
