name: E2E Tests

on:
  push:
    branches: [ main, master ]
    paths:
      # Only run on code changes, not documentation
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'Dockerfile'
      - 'homeassistant-addon/**'
      - '.github/workflows/e2e-tests.yml'
  workflow_dispatch:
  workflow_call:

# Limit GITHUB_TOKEN permissions to minimum required
permissions:
  contents: read

env:
  PYTHON_VERSION: "3.13"
  UV_CACHE_DIR: /tmp/.uv-cache
  HOMEASSISTANT_LOG_ALL: "true"
  TOOL_LOG_PATH: artifacts/tool_calls.ndjson.zst

jobs:
  # Comprehensive E2E validation for main branch
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - uses: actions/checkout@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: uv sync --all-extras --dev

    - name: Run full E2E test suite
      run: |
        echo "üöÄ Running full E2E test suite with 3 workers..."
        mkdir -p artifacts
        uv run pytest tests/src/e2e/ \
          -n3 \
          --tb=short \
          -v
        echo "‚úÖ Full E2E test suite passed"
      env:
        HOMEASSISTANT_URL: "http://localhost:8123"
        HOMEASSISTANT_TOKEN: "test-token"

    - name: Validate tool logging artifacts
      run: |
        echo "üîç Validating tool logging artifacts"
        uv run pytest tests/src/tool_logging/ --tb=short -v
      env:
        TOOL_LOG_PATH: artifacts/tool_calls.ndjson.zst
        TOOL_LOG_REQUIRED: "1"
