name: SemVer Release

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.13"

jobs:
  # Semantic versioning and release creation
  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    permissions:
      contents: write      # Required to push commits and tags
      id-token: write      # Required for trusted publishing
      pull-requests: write # Required to create pull requests
      issues: write        # Required for GitHub releases

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Python Semantic Release
      id: semantic
      uses: python-semantic-release/python-semantic-release@v10.5.2
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        verbosity: "2"
        # Don't create GitHub release here - build-binary.yml will create it with binaries
        vcs_release: "false"

    - name: Copy changelog to addon directory
      if: steps.semantic.outputs.released == 'true'
      run: |
        set -e
        cp CHANGELOG.md homeassistant-addon/CHANGELOG.md
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add homeassistant-addon/CHANGELOG.md
        git diff --staged --quiet || git commit -m "chore(addon): sync changelog for Home Assistant add-on [skip ci]"
        git push
