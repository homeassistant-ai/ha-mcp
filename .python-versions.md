# Python Version Management

This project uses **Renovate** to automatically manage Python version support.

## Policy

- **Support 2 versions**: Current and previous actively supported Python versions
- **Upgrade delay**: Wait 6 months after a new Python version is released
- **Centralized config**: `.python-versions.json` is the single source of truth

## How It Works

### Centralized Configuration

`.python-versions.json` contains:
```json
{
  "current": "3.13",    // Latest supported version
  "previous": "3.12",   // Previous supported version
  "minimum": "3.12",    // For requires-python in pyproject.toml
  "maximum_exclusive": "3.14"  // For requires-python upper bound
}
```

### Automated Updates via Renovate

**Workflow**: `.github/workflows/renovate.yml`
- Runs weekly (Mondays at 9:00 UTC)
- Can be manually triggered

**Configuration**: `renovate.json`
- Monitors Python version releases
- Waits 6 months (`minimumReleaseAge: "180 days"`) before proposing upgrades
- Uses `postUpgradeTasks` to update multiple files automatically

### Files Updated Automatically

When Renovate detects a new Python version (after 6 months):

1. **`.python-versions.json`** - Version metadata
2. **`pyproject.toml`** - Package metadata:
   - `requires-python` constraint
   - Python version classifiers
   - `mypy` python_version (set to minimum)
3. **`Dockerfile`** and **`homeassistant-addon/Dockerfile`** - Docker base images (set to minimum)
4. **`.github/workflows/pr.yml`** - Test matrix (via dynamic loading)
5. **`.github/workflows/test.yml`**, **`.github/workflows/e2e-tests.yml`**, **`.github/workflows/semver-release.yml`** - PYTHON_VERSION env vars (set to current)

### Dynamic Test Matrix

The PR workflow reads Python versions at runtime from `.python-versions.json`:

```yaml
jobs:
  get-python-versions:
    # Reads .python-versions.json
    # Outputs: ["3.12", "3.13"]

  e2e-validation:
    needs: get-python-versions
    matrix:
      python-version: ${{ fromJSON(needs.get-python-versions.outputs.python-versions) }}
```

## Manual Upgrade Process

If you need to upgrade Python versions manually:

1. **Update `.python-versions.json`**:
   ```json
   {
     "current": "3.14",
     "previous": "3.13",
     "minimum": "3.13",
     "maximum_exclusive": "3.15"
   }
   ```

2. **Update `pyproject.toml`**:
   ```toml
   requires-python = ">=3.13,<3.15"
   classifiers = [
       "Programming Language :: Python :: 3.13",
       "Programming Language :: Python :: 3.14",
   ]

   [tool.mypy]
   python_version = "3.13"  # Set to minimum
   ```

3. **Update Dockerfiles**:
   ```dockerfile
   # Dockerfile
   FROM ghcr.io/astral-sh/uv:0.9.9-python3.13-bookworm-slim

   # homeassistant-addon/Dockerfile
   FROM ghcr.io/astral-sh/uv:python3.13-bookworm
   ```

4. **Update workflow env vars** (test.yml, e2e-tests.yml, semver-release.yml):
   ```yaml
   env:
     PYTHON_VERSION: "3.14"  # Set to current
   ```

5. **Test the changes**:
   ```bash
   git push  # PR workflow will test both versions automatically
   ```

## Why This Approach?

✅ **Single source of truth** - All version info in `.python-versions.json`
✅ **Automatic updates** - Renovate handles the upgrade PR
✅ **Safe upgrades** - 6-month delay ensures stability
✅ **Minimal maintenance** - Only 2 versions to support
✅ **No hardcoded versions** - Dynamic test matrix

## Related Links

- Python EOL dates: https://endoflife.date/python
- Renovate docs: https://docs.renovatebot.com/
- GitHub Action: https://github.com/renovatebot/github-action
